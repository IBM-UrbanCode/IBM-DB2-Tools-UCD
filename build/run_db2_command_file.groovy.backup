import com.urbancode.air.CommandHelper;
import com.urbancode.air.AirPluginTool;

def apTool = new AirPluginTool(this.args[0], this.args[1])
def props = apTool.getStepProperties();

def commandBody = props['commandBody'] != "" ? props['commandBody'] : null
def commandFile = props['commandFile'] != "" ? props['commandFile'] : null
def commandArgs = props['commandArgs'] != "" ? props['commandArgs'] : null

final File PLUGIN_HOME = new File(System.getenv().get("PLUGIN_HOME"))

if (commandBody == null && commandFile == null) {
    println "You must provide either a Script Body or a Script File"
    System.exit(1)
}

if (commandBody != null && commandFile != null) {
    println "You must provide either a Script Body or a Script File, not both"
    System.exit(1)
}

def String getArch() {
    String result
    String arch = System.getProperty("os.arch").toLowerCase(Locale.US)

    if (arch.indexOf("amd64") > -1 || arch.indexOf("x64") > -1 || arch.indexOf("x86_64") > -1) {
        result = "x64"
    }
    else if (arch.indexOf("x86") > -1 || arch.indexOf("386") > -1 || arch.indexOf("486") > -1 ||
             arch.indexOf("586") > -1 || arch.indexOf("686") > -1 || arch.indexOf("pentium") > -1) {
        result = "x86"
    }
    else {
        result = "unknown"
    }
             
    return result
}

def arch = getArch()
def libraryPath = new File(PLUGIN_HOME, "lib/native/${arch}/WinAPI.dll")
System.setProperty("com.urbancode.winapi.WinAPI.dllPath", libraryPath.absolutePath)

def commandPath = ""

if (commandBody != null) {
    def commandData = File.createTempFile("tmp",".cmd")
    commandData.deleteOnExit()
    commandData.createNewFile()
    commandData.write("")
    commandData.write(commandBody)
    commandPath = commandData.getAbsolutePath()
}
else {
    commandPath = commandFile
}

def runFile = File.createTempFile("tmp",".bat")
runFile.deleteOnExit()
runFile.createNewFile()
runFile.write("")

def ln = System.getProperty('line.separator')

def db2Commands = new File(commandPath)
db2Commands.eachLine 
{	db2Command ->

	if (commandArgs != null) {	
		def commandArgsList = commandArgs.split()
		def k = 0
		while (k < commandArgsList.size()) {	
			def searchString = "{" + (k + 1) + "}"
			def replaceString = commandArgsList[k]
			
			db2Command = db2Command.replace(searchString, replaceString)
			k++
		}
	}

	// Escape special DOS characters so they can be interpreted by DB2
	db2Command = db2Command.replace("<", "^<")
	db2Command = db2Command.replace(">", "^>")
	db2Command = db2Command.replace("%", "^%")
	
	println("DB2 Command : " + db2Command);
	
	runFile.append(db2Command)
	runFile.append(ln)
}

runPath = runFile.getAbsolutePath()
	
execString = "cmd /c db2cmdadmin /c /w /i $runPath";

Process proc = execString.execute();
proc.waitFor();

println("${proc.getText()}")
println("Command exit code: ${proc.exitValue()}")

exitCode = proc.exitValue()

if (exitCode != 0) {
	println "Command failed."
	System.exit(exitCode)
}
else {
	println "Command executed successfully."
}